using System;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using GlobalX.ChatBots.Core.Messages;
using PockyBot.NET.Constants;
using PockyBot.NET.Persistence.Models;
using PockyBot.NET.Persistence.Repositories;

namespace PockyBot.NET.Services.Triggers
{
    internal class LocationConfig : ITrigger, IHelpMessageTrigger
    {
        private readonly ILocationRepository _locationRepository;
        private readonly IPockyUserRepository _pockyUserRepository;

        public string Command => Commands.LocationConfig;

        public bool DirectMessageAllowed => false;

        public bool CanHaveArgs => true;

        public Role[] Permissions => Array.Empty<Role>();

        public LocationConfig(ILocationRepository locationRepository, IPockyUserRepository pockyUserRepository)
        {
            _locationRepository = locationRepository;
            _pockyUserRepository = pockyUserRepository;
        }

        public async Task<Message> Respond(Message message)
        {
            var fullText = message.MessageParts.Skip(1).Select(x => x.Text);
            var commands = string.Join("", fullText)
                .Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);

            if (commands.Length < 2)
            {
                return new Message
                {
                    Text = "Please specify a command. Possible values are get, add, and delete."
                };
            }

            var locations = _locationRepository.GetAllLocations();
            string response;

            switch (commands[1].ToLower(CultureInfo.InvariantCulture))
            {
                case Actions.Get:
                    response = GetLocationMessage(locations);
                    break;
                case Actions.Add:
                    response = await AddLocation(message, commands, locations).ConfigureAwait(false);
                    break;
                case Actions.Delete:
                    response = await DeleteLocation(message, commands, locations).ConfigureAwait(false);
                    break;
                default:
                    response = "Unknown command. Possible values are get, add, and delete.";
                    break;
            }

            return new Message
            {
                Text = response
            };
        }

        public string GetHelpMessage(string botName, PockyUser user)
        {
            if (user.HasRole(Role.Admin) || user.HasRole(Role.Config)) {
                return "### How to configure location config values 🌏!\n" +
                       $"1. To get/edit/delete locations, type `@{botName} {Commands.LocationConfig} {Actions.Get}|{Actions.Add}|{Actions.Delete} {{location}}`\n" +
                       "1. I will respond in the room you messaged me in.";
            }
            return "### How to get location values 🌏!\n" +
                   $"1. To get a list of locations, type `@{botName} {Commands.LocationConfig} {Actions.Get}`\n" +
                   "    * To configure locations, please ask an admin.\n" +
                   "1. I will respond in the room you messaged me in.";
        }

        private static string GetLocationMessage(string[] locations)
        {
            if (locations.Length == 0)
            {
                return "No locations added.";
            }

            return $"Here are the current locations:\n* {string.Join("\n* ", locations)}";
        }

        private async Task<string> AddLocation(Message message, string[] commands, string[] locations)
        {
            var user = _pockyUserRepository.GetUser(message.Sender.UserId);
            if (!(user.HasRole(Role.Admin) || user.HasRole(Role.Config)))
            {
                return "Permission denied. You may only use the 'get' command.";
            }

            if (commands.Length != 3)
            {
                return "You must specify a location name to add.";
            }

            if (locations.Contains(commands[2], StringComparer.InvariantCultureIgnoreCase))
            {
                return $"Location value {commands[2]} has already been added.";
            }

            await _locationRepository.AddLocation(commands[2]);
            return "Location has been added.";
        }

        private async Task<string> DeleteLocation(Message message, string[] commands, string[] locations)
        {
            var user = _pockyUserRepository.GetUser(message.Sender.UserId);
            if (!(user.HasRole(Role.Admin) || user.HasRole(Role.Config)))
            {
                return "Permission denied. You may only use the 'get' command.";
            }

            if (commands.Length != 3)
            {
                return "You must specify a location name to delete.";
            }

            if (!locations.Contains(commands[2], StringComparer.InvariantCultureIgnoreCase))
            {
                return $"Location value {commands[2]} does not exist.";
            }

            await _locationRepository.DeleteLocation(commands[2]);
            return "Location has been deleted.";
        }
    }
}
